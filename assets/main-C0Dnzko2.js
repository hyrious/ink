const L=(t,e,i)=>t<e?e:t>i?i:t;class p{constructor(e,i){this.x=e,this.y=i}static of(e,i){return new p(e,i)}static from(e){return new p(e.x,e.y)}add(e){return new p(this.x+e.x,this.y+e.y)}subtract(e){return new p(this.x-e.x,this.y-e.y)}multiply(e){return new p(this.x*e,this.y*e)}normalize(e=Math.hypot(this.x,this.y)){return new p(this.x/e,this.y/e)}permutate(){return new p(-this.y,this.x)}negative(){return new p(-this.x,-this.y)}middle(e){return new p((this.x+e.x)/2,(this.y+e.y)/2)}rotate(e,i){const s=Math.sin(i),r=Math.cos(i),o=this.x-e.x,l=this.y-e.y,a=o*r-l*s,h=o*s+l*r;return new p(a+e.x,h+e.y)}dot(e){return this.x*e.x+this.y*e.y}lerp(e,i){return new p(this.x+(e.x-this.x)*i,this.y+(e.y-this.y)*i)}project(e,i){return new p(this.x+e.x*i,this.y+e.y*i)}}class re{constructor(e=.36){this.value=this.last=this.target=e}set(e){return this.target=e,this}update(e){if(e||(e=.016667),this.value>=0&&this.target>=0&&this.last>=0){let s=this.target-this.value,r=(this.value-this.last)/e,o=2*s,l=.1*r,a=o-l,h=(r+a)*e;this.last=this.value,Math.abs(h)<.01&&Math.abs(s)<.01?this.value=this.target:this.value+=h}return this.value}}class v{constructor(e,i,s,r){this.x=e,this.y=i,this.p=s,this.t=r}static of(e,i,s,r){return new v(e,i,s,r)}static fromEvent(e,i=L(e.pressure||.5,0,1)){return new v(e.clientX,e.clientY,i,performance.timeOrigin+e.timeStamp)}static fromJSON(e){return new v(e.x,e.y,e.p,e.t)}}class z{constructor(e,i,s,r){this.p=e,this.v=i,this.d=s,this.l=r}static of(e,i,s,r){return new z(e,i,s,r)}static fromJSON(e){return new z(v.fromJSON(e.p),p.from(e.v),e.d,e.l)}}function oe(t,e){return e-t.p.t>60?Math.min(t.p.p+.05,1):Math.min(t.p.p+.05*(e-t.p.t)/60,1)}function le(t,e,i){return i-e>60?Math.min(t+.05,1):Math.min(t+.05*(i-e)/60,1)}class C{constructor(e,i=e.length>0?e[e.length-1].l:0){this.points=e,this.length=i,this.segments=[0],this.pending={__proto__:null}}static of(e=[]){let i=new C([],0);for(let s of e)i._push(s);return i._updateSegments(),i}static fromJSON(e){let i=new C(e.points.map(z.fromJSON),e.length);return i.segments=e.segments,i.pending=e.pending,i}get empty(){return this.length==0}get dot(){return this.points.length==1}insert(e,i){if(e==this.points.length){for(let s of i)this._push(s);e=this.points.length,(i=this.pending[e])?(delete this.pending[e],this.insert(e,i)):this._updateSegments()}else if(e>this.points.length)this.pending[e]=i;else throw new RangeError(`Position ${e} conflicts with existing points`);return this}push(e){return this._push(e),this._updateSegments(),this}_push(e){let i=this.points;if(i.length>0){let s=i[i.length-1],r=Math.hypot(e.x-s.p.x,e.y-s.p.y);if(this._updateLength(r),this.length-s.l<4){s.p.p=Math.max(s.p.p,e.p);return}i.push(z.of(e,p.from(e).subtract(s.p).normalize(),r,this.length))}else i.push(z.of(e,p.of(0,0),0,0))}isSpreading(e=performance.timeOrigin+performance.now()){return this.points.length>0&&e-this.points[this.points.length-1].p.t<60}outline(e,i,s=performance.timeOrigin+performance.now(),r=!0){let o=this.segments.find(a=>e<a),l=this.points.slice(e>0?e-1:e,o);if(l.length>1){let a=[],h=[],d=l.length,F=i,w=l[0].p.p,_=l[d-1].p.p,J=!0,S=-1,q=l[0].p.t,V=new re(Math.max(w,.36/5));if(r&&o==null&&d>=2&&(w==.5||w==1||_<.72)){J=!1;let c=l[d-2],m=c.d,E=c,b=0;for(let y=d-3;y>=0&&(E=l[y],m+=E.d,b=c.p.t-E.p.t,!(b<=0||b>100));y--)S=y;m>.51*i?S+=Math.ceil((d-S)/3):S=d-3}for(let c=0;c<d;c++){let{p:m,v:E,d:b}=l[c];c==0&&(b=0,E=l[1].v);let y=Math.min(1,b/i),te=Math.min(1,1-y),M=Math.min(1,w+(te-w)*(y*.5)),X=(c<d-1?l[c+1]:l[c]).v,ie=c<d-1?E.dot(X):1;if(M=V.set(M).update((m.t-q)/800),!J&&c>=S){let G=1-(d-c-1)/(d-S);M=M*(1-G*G)}F=L(i*.5*le(M,m.t,s),.75,i/2);let Y=X.lerp(E,ie).permutate().multiply(F),se=p.from(m).subtract(Y),ne=p.from(m).add(Y);a.push(se),h.push(ne),q=m.t,w=m.p}let K=[],ee=h[0],U=[];for(let c=1/13,m=0;m<=1;m+=c)K.push(ee.rotate(l[0].p,3.1416926535897933*m));if(J){let c=l[d-1],m=c.v.negative().permutate(),E=p.from(c.p).project(m,F);for(let b=1/13,y=0;y<1;y+=b)U.push(E.rotate(c.p,3.1416926535897933*y))}return a.concat(U,h.reverse(),K)}else if(l.length==1){let a=l[0],h=p.from(a.p).project(p.of(1,0),i*.36*oe(a,s)),d=[];for(let F=1/13,w=0;w<=2;w+=F)d.push(h.rotate(a.p,3.1416926535897933*w));return d}else return[]}stroke(e=this.points.map(s=>s.p),i=!1){let s=e.length;if(s==0)return"";let r=e[0],o="",l,a;if(i){a=p.from(r).middle(e[s-1]),o+=`M${a.x.toFixed(2)},${a.y.toFixed(2)}`;for(let h=1;h<s;h++)l=e[h],a=p.from(r).middle(l),o+=`Q${r.x.toFixed(2)},${r.y.toFixed(2)} ${a.x.toFixed(2)},${a.y.toFixed(2)}`,r=l;s>1&&(o+="Z")}else{o+=`M${r.x.toFixed(2)},${r.y.toFixed(2)}`;for(let h=1;h<s;h++)l=e[h],a=p.from(r).middle(l),h==1?o+=`L${a.x.toFixed(2)},${a.y.toFixed(2)}`:o+=`Q${r.x.toFixed(2)},${r.y.toFixed(2)} ${a.x.toFixed(2)},${a.y.toFixed(2)}`,r=l;s>1&&(o+=`L${r.x.toFixed(2)},${r.y.toFixed(2)}`)}return o}_updateLength(e){this.length+=e}_updateSegments(){let e=this.segments,i=this.points,s=i.length;for(let r=e[e.length-1]+1;r<s;r++)i[r].v.dot(i[r-1].v)<0&&(e.push(r),r++)}}let W=document.getElementById("app"),u=W.appendChild(document.createElementNS("http://www.w3.org/2000/svg","svg")),g=W.appendChild(document.createElement("div")),n={color:document.getElementById("stroke-color"),size:document.getElementById("stroke-size"),clear:document.getElementById("clear"),undo:document.getElementById("undo"),redo:document.getElementById("redo"),save:document.getElementById("save"),load:document.getElementById("load"),pressure:document.getElementById("pressure"),tail:document.getElementById("tail"),eraser:document.getElementById("eraser"),smooth:document.getElementById("smooth")},ae=n.pressure.checked,he=n.tail.checked,ue=n.smooth.value,pe=n.size.valueAsNumber;u.setAttribute("fill-rule","nonzero");u.setAttribute("fill","currentColor");u.style.cssText=`display: block; width: 100%; height: 100%;
font-size: 0; touch-action: none; position: relative; contain: content;
overflow: hidden; overscroll-behavior: none;`;g.style.cssText=`display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
touch-action: none; contain: content; z-index: 1;`;let ce=matchMedia("(prefers-color-scheme: dark)"),Z=()=>ce.matches?"#ffffff":"#000000";n.color.value=Z();n.color.onchange=n.color.oninput=()=>{P()};n.size.onchange=n.size.oninput=()=>{P()};n.clear.onclick=()=>{let t=Array.from(u.children);u.textContent="",A.commit(()=>u.append(...t),()=>u.textContent="")};n.undo.onclick=()=>A.undo();n.redo.onclick=()=>A.redo();n.save.onclick=async()=>{let t=[];for(const s of u.children){let r=Number.parseInt(s.dataset.index??"");t.push(D[r])}let e=JSON.stringify(t);n.save.disabled=!0;let i=await showSaveFilePicker({id:"ink",startIn:"downloads",suggestedName:"ink.json"}).catch(console.warn);if(i){let s=await i.createWritable().catch(console.warn);s&&(await s.write(e),await s.close())}n.save.disabled=!1};n.load.onclick=async()=>{let[t]=await showOpenFilePicker({id:"ink",startIn:"downloads"}).catch(e=>(console.warn(e),[]));if(t){let e=await t.getFile().catch(console.warn);if(e){let i;try{i=JSON.parse(await e.text())}catch(s){console.warn(s)}if(i&&Array.isArray(i)){n.clear.click();let s=101;for(let r of i){let o=C.fromJSON(r),l=u.appendChild(document.createElementNS("http://www.w3.org/2000/svg","path"));l.style.pointerEvents="none",l.style.fill=n.color.value,l.dataset.index=String(D.push(o)-1),f[s]=[o,l],$[s]=!0,s++}B();for(let r=101;r<s;r++)delete f[r]}}}};let N;n.pressure.oninput=()=>{N=n.pressure.checked?void 0:.5,P()};n.tail.oninput=()=>{P()};n.smooth.onchange=n.smooth.oninput=()=>{P()};n.eraser.oninput=()=>{let t=n.eraser.checked;g.style.cursor=t?`url(https://api.iconify.design/mdi:eraser.svg?color=${encodeURIComponent(n.color.value)}) 12 32, auto`:"default",g.style.display=t?"block":"none"};for(let t=1;t<=15;t++){let e=document.createElement("option");e.value=e.textContent=String(t),n.smooth.appendChild(e)}let P=()=>{let t="";n.color.value!==Z()&&(t+=`&color=${n.color.value.slice(1)}`),n.size.valueAsNumber!==pe&&(t+=`&size=${n.size.valueAsNumber}`),n.pressure.checked!==ae&&(t+=`&pressure=${n.pressure.checked?1:0}`),n.tail.checked!==he&&(t+=`&tail=${n.tail.checked?1:0}`),n.smooth.value!==ue&&(t+=`&smooth=${n.smooth.value}`),history.replaceState({},"",t?t.replace("&","?"):location.pathname)},k=new URL(location.href).searchParams;k.has("color")&&(n.color.value="#"+k.get("color"));k.has("size")&&(n.size.value=k.get("size"));k.has("pressure")&&(n.pressure.checked=k.get("pressure")!=="0",n.pressure.dispatchEvent(new InputEvent("input")));k.has("tail")&&(n.tail.checked=k.get("tail")!=="0",n.tail.dispatchEvent(new InputEvent("input")));k.has("smooth")&&(n.smooth.value=k.get("smooth"));P();let x=new Map;u.onpointerdown=t=>{let e=t.pointerId;x.has(e)&&H(e),x.set(e,t),t.preventDefault(),t.stopPropagation(),u.setPointerCapture(e),ve(e,v.fromEvent(t,N))};u.onpointermove=t=>{let e=t.pointerId;if(t.preventDefault(),t.stopPropagation(),x.has(e)){let i=x.get(e);if(i.clientX===t.clientX&&i.clientY===t.clientY)return;if(x.set(e,t),t.getCoalescedEvents)for(let s of t.getCoalescedEvents())T(e,v.fromEvent(s,N));else T(e,v.fromEvent(t,N))}};u.onpointerup=u.onpointerout=t=>{let e=t.pointerId;if(t.preventDefault(),t.stopPropagation(),x.has(e)){if(t.getPredictedEvents){let i=x.get(e).getPredictedEvents()[0];i&&T(e,v.fromEvent(i,N))}ye(e),x.delete(e)}};u.onpointercancel=t=>{let e=t.pointerId;t.preventDefault(),t.stopPropagation(),x.has(e)&&(H(e),x.delete(e))};u.ontouchstart=u.ontouchmove=u.ontouchend=u.ontouchcancel=t=>{t.preventDefault(),t.stopPropagation()};let I;g.onpointerdown=t=>{t.preventDefault(),t.stopPropagation(),g.setPointerCapture(t.pointerId),j(I=v.fromEvent(t))};g.onpointermove=t=>{if(I){t.preventDefault(),t.stopPropagation();let e=v.fromEvent(t);j(e),I=e}};g.onpointerup=g.onpointerout=t=>{I=void 0};g.ontouchstart=g.ontouchmove=g.ontouchend=g.ontouchcancel=t=>{t.preventDefault(),t.stopPropagation()};let A={index:0,stack:[],get undoable(){return this.index>0},get redoable(){return this.index<this.stack.length},commit(t,e){for(this.stack[this.index]={undo:t,redo:e},this.index++;this.stack.length>20;)this.stack.shift(),this.index--;this.stack.length=this.index,this.update()},undo(){this.undoable&&(this.index--,this.stack[this.index].undo(),this.update())},redo(){this.redoable&&(this.stack[this.index].redo(),this.index++,this.update())},update(){n.undo.disabled=!this.undoable,n.redo.disabled=!this.redoable}};class de{push(e){return this.item=e,this}dup(){if(this.item)return this}get(){return this.item}}class fe{constructor(e,i=2){this.compute=e,this.capacity=i,this.items=[],this.size=0}push(e){for(this.items.push(e),this.size++;this.size>this.capacity;)this.items.shift(),this.size--;return this}dup(){if(this.size>0)return this.push(this.items[this.items.length-1])}get(){return this.compute(this.items)}}let me=t=>{let e=0,i=0,s=.5,r=0;for(let o of t)e+=o.x,i+=o.y,s=o.p,r=o.t;return v.of(e/t.length,i/t.length,s,r)},ge=t=>{if(n.smooth.value=="0")return new de().push(t);{let e=Number.parseInt(n.smooth.value)+1;return new fe(me,e).push(t)}},f={},O={},$={},D=[],ve=(t,e)=>{let i=C.of([e]),s=u.appendChild(document.createElementNS("http://www.w3.org/2000/svg","path"));s.style.pointerEvents="none",s.style.fill=n.color.value,f[t]=[i,s],O[t]=ge(e),$[t]=!0,B()},T=(t,e)=>{f[t]&&(f[t][0].push(O[t].push(e).get()),$[t]=!0,B(),Q())},H=t=>{f[t]&&(f[t][1].remove(),delete O[t],delete f[t],delete $[t])},ye=t=>{if(f[t]){let[e,i]=f[t],s=!0;e.empty&&!e.dot&&(i.remove(),s=!1),B(),delete O[t],delete $[t],Q(),s&&A.commit(()=>i.remove(),()=>u.append(i)),s&&(i.dataset.index=String(D.push(e)-1))}},j=t=>{let e=u.createSVGPoint();e.x=t.x,e.y=t.y;for(let i of u.children)i.isPointInFill(e)&&i.remove();if(I){let i=t.x-I.x,s=t.y-I.y;for(let r=0;r<1;r+=.1){let o=u.createSVGPoint();o.x=t.x-r*i,o.y=t.y-r*s;for(let l of u.children)l.isPointInFill(o)&&l.remove()}}},B=()=>{let t=performance.timeOrigin+performance.now(),e=n.size.valueAsNumber,i=n.tail.checked;for(let s in $){if(f[s]){let r=x.has(+s),[o,l]=f[s],a="";for(let h of o.segments){let d=o.outline(h,e,t,!r&&i);a+=o.stroke(d,!0)}l.setAttribute("d",a)}delete $[s]}},R=0,Q=()=>{cancelAnimationFrame(R),R=requestAnimationFrame(xe)},xe=()=>{var e;B();let t=!1;for(let i in f){let s=(e=O[i])==null?void 0:e.dup();s&&f[i][0].push(s.get()),f[i][0].isSpreading()&&($[i]=!0,t=!0)}t&&Q()},we=/Mac/.test(navigator.platform);document.onkeydown=t=>{let e=t.ctrlKey,i=t.shiftKey,s=t.metaKey,r=t.altKey,o=t.keyCode,l=we?s:e;const a=h=>{t.preventDefault(),h.focus(),h.click()};if(!e&&!i&&!s&&!r){if(o==80&&(n.eraser.checked?a(n.eraser):a(n.pressure)),o==69&&a(n.eraser),o==219||o==221){let h=n.size.valueAsNumber,d=o==221?5:-5;n.size.value=""+L(h+d,+n.size.min,+n.size.max),n.size.dispatchEvent(new InputEvent("input"))}o===84&&a(n.tail)}else l&&!i&&o==90?a(n.undo):l&&i&&o==90?a(n.redo):l&&!i&&o==83?a(n.save):l&&!i&&o==79&&a(n.load)};Object.assign(globalThis,{$settings:n,$svg:u,strokes:f,dirty:$,undoStack:A,allStrokes:D});
//# sourceMappingURL=main-C0Dnzko2.js.map

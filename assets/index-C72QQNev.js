const A=({x:i,y:t},e=Math.hypot(i,t))=>({x:i/e,y:t/e}),I=(i,t)=>({x:i.x+t.x,y:i.y+t.y}),P=(i,t)=>({x:i.x-t.x,y:i.y-t.y}),B=(i,t)=>({x:i.x*t,y:i.y*t}),O=({x:i,y:t})=>({x:t,y:-i}),F=({x:i,y:t})=>({x:-i,y:-t}),D=({x:i,y:t},e,n)=>{const r=Math.sin(n),s=Math.cos(n),o=i-e.x,h=t-e.y,l=o*s-h*r,u=o*r+h*s;return{x:l+e.x,y:u+e.y}},J=(i,t)=>i.x*t.x+i.y*t.y,et=(i,t,e)=>I(i,B(P(t,i),e)),L=(i,t,e)=>I(i,B(t,e));class it{constructor(){this._observers=new Map}on(t,e){let n=this._observers.get(t);return n===void 0&&this._observers.set(t,n=new Set),n.add(e),this.off.bind(this,t,e)}off(t,e){let n=this._observers.get(t);n!==void 0&&(n.delete(e),n.size==0&&this._observers.delete(t))}emit(t,...e){let n=this._observers.get(t);n&&n.forEach(r=>this._invoke(r,e))}_invoke(t,e){try{t(...e)}catch(n){console.error(n)}}dispose(){this._observers.clear()}}class C extends it{constructor(t=!1,e=!0,n=!0){super(),this.paused=t,this.gesture=e,this.pressure=n,this._map=new Map,this._onpointerdown=s=>{if(this.paused)return;let o=s.pointerId;this._map.has(o)&&this.emit("cancel",o),this._map.set(o,s),s.preventDefault(),s.stopPropagation(),this._dom.setPointerCapture(o);let h=this._rect=this._dom.getBoundingClientRect();if(this._mapGesture(s)&&this._map.size>1){let l=this._pinch=new st(this);this._map.forEach((u,p)=>{l.has(p)||(o!=p&&this.emit("cancel",p),l.add(u))})}else this.emit("open",o,{x:s.clientX-h.left,y:s.clientY-h.top,r:this._mapPressure(s.pressure)})},this._onpointermove=s=>{if(this.paused)return;let o=s.pointerId;if(s.preventDefault(),s.stopPropagation(),this._map.has(o)){let h=this._map.get(o);if(h.clientX==s.clientX&&h.clientY==s.clientY)return;if(this._map.set(o,s),this._pinch)this._pinch.move(s);else{let l;s.pointerType=="mouse"&&s.pressure==0&&(l=this._mapPressure(.5));let{left:u,top:p}=this._rect;if(s.getCoalescedEvents)for(let x of s.getCoalescedEvents())this.emit("update",o,{x:x.clientX-u,y:x.clientY-p,r:l??this._mapPressure(s.pressure)});else this.emit("update",o,{x:s.clientX-u,y:s.clientY-p,r:l??this._mapPressure(s.pressure)})}}},this._onpointerup=s=>{var h;if(this.paused)return;let o=s.pointerId;if(s.preventDefault(),s.stopPropagation(),this._map.has(o)){if(this._pinch)this._pinch.delete(o),this._pinch.empty&&(this._pinch=null);else{let{left:l,top:u}=this._rect;if(s.getPredictedEvents){let p=(h=this._map.get(o))==null?void 0:h.getPredictedEvents()[0];p&&this.emit("update",o,{x:p.clientX-l,y:p.clientY-u,r:this._mapPressure(p.pressure)})}this.emit("close",o)}this._map.delete(o)}},this._onpointercancel=s=>{if(this.paused)return;let o=s.pointerId;s.preventDefault(),s.stopPropagation(),this._map.delete(o),this._pinch?(this._pinch.delete(o),this._pinch.empty&&(this._pinch=null)):this.emit("cancel",o)},this._onwheel=s=>{if(this.paused)return;s.preventDefault(),s.stopPropagation();let{deltaX:o,deltaY:h}=s,l=Math.hypot(o,h),u=0,p=0;this._browser.windows&&(l=-l),o+h<0&&(l=-l),this._browser.mac&&s.ctrlKey?l=-l*.5:this._browser.mac&&(s.wheelDelta%120!=0||s.movementX!=0||s.deltaX!=0)||this._browser.windows&&!s.ctrlKey?(u=-o,p=-h,l=0):l*=.035,l=Math.max(l,-40)*.02;let{left:x,top:E}=this._rect;this.emit("wheel",{x:s.clientX-x,y:s.clientY-E,deltaX:u,deltaY:p,deltaScale:l})};const r=typeof navigator<"u"?navigator:{platform:""};this._browser={mac:/Mac/.test(r.platform),windows:/Win/.test(r.platform)}}get dom(){return this._dom}set dom(t){this._dom!=t&&(this._dom=t,this._listen(this._dom,{pointerdown:this._onpointerdown,pointermove:this._onpointermove,pointerup:this._onpointerup,pointerout:this._onpointerup,pointercancel:this._onpointercancel,wheel:this._onwheel}),this._dom&&(this._rect=this._dom.getBoundingClientRect()))}pause(){this.paused=!0}resume(){this.paused=!1}_listen(t,e){if(this._unlistenDOM&&(this._unlistenDOM(),this._unlistenDOM=void 0),t){for(let n in e)t.addEventListener(n,e[n]);this._unlistenDOM=()=>{for(let n in e)t.removeEventListener(n,e[n])}}}_clamp(t,e,n){return t<=e?e:t>n?n:t}_mapPressure(t){return this.pressure===!0?t:this._clamp(this.pressure||.5,0,1)}_mapGesture(t){return this.gesture===!0||this.gesture&&t.pointerType=="touch"}dispose(){this._unlistenDOM&&(this._unlistenDOM(),this._unlistenDOM=void 0),super.dispose()}static create(t={}){let e=new C(t.paused,t.gesture,t.pressure);return e.dom=t.dom,e}}class st{constructor(t){this.input=t,this.points=new Map,this.x0=0,this.y0=0,this.x1=0,this.y1=0,this.scale=1,this.ox=0,this.oy=0,this.rate=1,this.initialized=!1,this.size=0}get empty(){return this.points.size==0}has(t){return this.points.has(t)}add(t){this.points.set(t.pointerId,t),this.update()}move(t){this.points.set(t.pointerId,t),this.update()}delete(t){this.points.delete(t),this.update()}update(){let t=this.desc(),e=1;this.size==0&&this.points.size==1?e=0:this.size>0&&this.points.size==0&&(e=2),this.initialized?(this.size!==this.points.size&&(this.ox=this.x1-t.x,this.oy=this.y1-t.y,this.rate=this.scale/t.d,this.size=this.points.size),this.x1=t.x+this.ox,this.y1=t.y+this.oy,this.scale=t.d*this.rate):(this.ox=this.oy=0,this.rate=1/t.d,this.x1=this.x0=t.x,this.y1=this.y0=t.y,this.scale=1,this.size=this.points.size,this.initialized=!0),this.input.emit("pinch",{phase:e,x:this.x0,y:this.y0,deltaX:this.x0-this.x1/this.scale,deltaY:this.y0-this.y1/this.scale,deltaScale:this.scale})}desc(){let t=0,e=0,n=0;for(let r of this.points.values())t+=r.clientX,e+=r.clientY;this.points.size>0&&(t/=this.points.size,e/=this.points.size);for(let r of this.points.values())n+=Math.hypot(r.clientX-t,r.clientY-e);return{x:t,y:e,d:n||1}}}class b{constructor(t,e,n,r,s){this.p=t,this.r=e,this.v=n,this.d=r,this.l=s}toJSON(){return[this.p.x,this.p.y,this.r]}dup(t=this.r){return new b(this.p,t,this.v,this.d,this.l)}}class ${constructor(t,e=t.length>0?t[t.length-1].l:0){this.points=t,this.length=e,this.sections=[0],this.pending={__proto__:null},this.queue=[],this.updateSections()}get empty(){return this.points.length==0}get dot(){return this.points.length==1}insert(t,e){if(t==this.points.length)e.forEach(n=>this.push(n,!0)),t=this.points.length,(e=this.pending[t])?(delete this.pending[t],this.insert(t,e)):this.updateSections();else if(t>this.points.length)this.pending[t]&&console.warn(`Override pending points from ${t}`),this.pending[t]=e;else throw new RangeError(`Position ${t} conflicts with existing points`)}push(t,e=!1){let{points:n}=this;if(n.length>0){let r,s=n[n.length-1];r={x:(t.x+s.p.x)/2,y:(t.y+s.p.y)/2,r:t.r};let o=s.p,h=Math.hypot(r.x-o.x,r.y-o.y);if(this.updateLength(h),this.length-s.l<4){s.r=Math.max(s.r,r.r);return}n.push(new b(r,r.r,A(P(o,r)),h,this.length)),e||this.updateSections()}else n.push(new b(t,t.r,{x:1,y:1},0,0))}outline(t,e){let n=this.sections.find(s=>t<s),r=this.points.slice(t>0?t-1:t,n);if(r.length>1){let s=[],o=[],h=r.length,l=e,u=r[0].r,p=!0;n==null&&h>=2&&r[h-2].r==.5&&r[h-2].d>.4*e&&(r[h-1]=r[h-1].dup(.05),r[h-2]=r[h-2].dup(Math.max(.1,r[h-2].r-.3)),h>=3&&(r[h-3]=r[h-3].dup(Math.max(.1,r[h-3].r-.1))),p=!1);for(let a=0;a<h;a++){let{p:g,r:S,v:_,d:w}=r[a];a==0&&(w=0,a<h-1&&(_=r[a+1].v));let N=Math.min(1,w/e),H=Math.min(1,1-N),U=Math.min(1,u+(H-u)*(N*.3)),Y=(a<h-1?r[a+1]:r[a]).v,Z=a<h-1?J(_,Y):1;l=Math.max(e*(.5*U),.75);let q=B(O(et(Y,_,Z)),l),j=P(g,q);s.push(j);let tt=I(g,q);o.push(tt),u=S}let x=[],E=[];for(let a=1/13,g=a;g<=1;g+=a)x.push(D(o[0],r[0].p,3.1416926535897933*g));if(p){let a=r[h-1],g=O(F(a.v)),S=L(a.p,g,l);for(let _=1/13,w=_;w<1;w+=_)E.push(D(S,a.p,3.1416926535897933*w))}return s.concat(E,o.reverse(),x)}else if(r.length==1){let s=r[0],o=O(F(s.v)),h=L(s.p,o,e*.36*s.r),l=[];for(let u=1/13,p=0;p<=2;p+=u)l.push(D(h,s.p,3.1416926535897933*p));return l}else return[]}updateLength(t){this.length+=t}updateSections(){let{sections:t}=this;for(let e=t.length>1?t[t.length-1]+1:2,n=this.points.length;e<n;e++)this.points[e].d<1e3&&J(this.points[e].v,this.points[e-1].v)<0&&(t.push(e),e+=1)}updateCurr(t,e){for(this.queue.push(t);this.queue.length>e;)this.queue.shift();let n=0,r=0;for(let s of this.queue)n+=s.x,r+=s.y;return e=this.queue.length,{x:n/e,y:r/e,r:t.r}}toJSON(){return this.points.map(t=>t.toJSON())}static fromJSON(t){if(!t||!Array.isArray(t))throw new RangeError("Invalid JSON representation for Stroke");return $.create(t.map(e=>({x:e[0],y:e[1],r:e[2]})))}static create(t=[]){let e=[],n=0;if(t.length>0){let r=t[0],s=0;e.push(new b(r,r.r,{x:1,y:1},0,0));for(let o=1;o<t.length;o++){let h=t[o],l=Math.hypot(h.x-r.x,h.y-r.y);if(s+=l,s-n<4){e[e.length-1].r=h.r;continue}e.push(new b(h,h.r,A(P(r,h)),l,s)),r=h,n=s}n=s}return new $(e,n)}}let nt=document.getElementById("app"),m=document.createElementNS("http://www.w3.org/2000/svg","svg"),d=document.createElementNS("http://www.w3.org/2000/svg","g"),f={size:document.getElementById("stroke-size"),clear:document.getElementById("clear"),undo:document.getElementById("undo"),redo:document.getElementById("redo"),outline:document.getElementById("outline"),pressure:document.getElementById("pressure"),data:document.getElementById("data")},z=document.getElementById("log");function Q(...i){z.append(i.map(V).join(" ")+`
`),z.childNodes.length>20&&z.removeChild(z.firstChild)}function V(i){if(typeof i=="object"){if(typeof i=="function")return"Fn()";let t="{",e=!1;for(let n in i)t+=" "+n+": "+V(i[n])+",",e=!0;return t=e?t.slice(0,-1)+" }":t+"}",t}else return""+i}window.onerror=function(t){Q(t)};let rt=console.log;console.log=function(){return Q.apply(this,arguments),rt.apply(this,arguments)};let W=0,T=0;function ot(i){try{let t=JSON.stringify(i.toJSON()).length;T+=t,f.data.textContent=`${W.toFixed(1)}ms, ${R(t)} (Total: ${R(T)})`}catch(t){console.error(t)}}function R(i){return i<1024?i+" B":(i/1024).toFixed(1)+" kB"}let v={index:0,stack:[],get undoable(){return this.index>0},get redoable(){return this.index<this.stack.length},commit(i,t){for(this.stack[this.index]={undo:i,redo:t},this.index+=1;this.stack.length>20;)this.stack.shift(),this.index-=1;this.stack.length=this.index,this.update()},undo(){this.undoable&&(this.index-=1,this.stack[this.index].undo(),this.update())},redo(){this.redoable&&(this.stack[this.index].redo(),this.index+=1,this.update())},update(){f.undo.disabled=!this.undoable,f.redo.disabled=!this.redoable}};m.append(d);nt.append(m);f.clear.onclick=()=>{let i=Array.from(d.children);d.textContent="",v.commit(()=>d.append(...i),()=>d.textContent="")};f.undo.onclick=()=>v.undo();f.redo.onclick=()=>v.redo();d.setAttribute("fill","currentColor");f.outline.oninput=()=>{f.outline.checked?(d.setAttribute("fill","none"),d.setAttribute("stroke","currentColor"),d.setAttribute("stroke-width","1")):d.setAttribute("fill","currentColor")};m.setAttribute("fill-rule","nonzero");m.style.cssText=`display: block; width: 100%; height: 100%;
font-size: 0; touch-action: none; position: relative; contain: content;
overflow: hidden; overscroll-behavior: none;`;let y=!1,c={__proto__:null},M={__proto__:null},k=C.create({dom:m,gesture:!1});f.pressure.oninput=()=>{k.pressure=f.pressure.checked};k.on("open",(i,t)=>{let e=$.create([t]),n=document.createElementNS("http://www.w3.org/2000/svg","path");n.style.pointerEvents="none",c[i]=[e,n],M[i]=!0,d.append(n),!y&&(y=!0,queueMicrotask(X))});k.on("update",(i,t)=>{if(c[i]){let[e]=c[i];if(e.push(t),M[i]=!0,y)return;y=!0,queueMicrotask(X)}});k.on("cancel",i=>{c[i]&&(c[i][1].remove(),delete c[i])});k.on("close",i=>{if(c[i]){let[t,e]=c[i],n=!0;t.empty&&(e.remove(),n=!1),y||(y=!0,queueMicrotask(X)),ot(t),console.info(t),queueMicrotask(()=>{delete c[i]}),n&&v.commit(()=>e.remove(),()=>d.append(e))}});m.ontouchstart=m.ontouchmove=m.ontouchend=m.ontouchcancel=i=>{i.preventDefault(),i.stopPropagation()};const G=(i,t)=>({x:(i.x+t.x)/2,y:(i.y+t.y)/2}),ht=({x:i,y:t})=>`M${i.toFixed(2)},${t.toFixed(2)}`,K=({x:i,y:t})=>`L${i.toFixed(2)},${t.toFixed(2)}`,lt=(i,{x:t,y:e})=>`Q${i.x.toFixed(2)},${i.y.toFixed(2)} ${t.toFixed(2)},${e.toFixed(2)}`;function X(){if(!y)return;y=!1;let i=f.size.valueAsNumber,t=performance.now();for(let e in M){if(c[e]){let[n,r]=c[e],s="";for(let o of n.sections)s+=pt(n.outline(o,i));r.setAttribute("d",s)}delete M[e]}W=performance.now()-t}function pt(i){if(i.length==0)return"";let t=i.shift(),e=ht(t),n=1;for(let r of i)n&&(e+=K(G(t,r))),e+=lt(t,G(t,r)),n=0,t=r;return e+K(i[i.length-1])}Object.assign(window,{debug:{undoStack:v,strokes:c,dirty:M,input:k}});
//# sourceMappingURL=index-C72QQNev.js.map

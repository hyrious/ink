const q=({x:s,y:t},e=Math.hypot(s,t))=>({x:s/e,y:t/e}),I=(s,t)=>({x:s.x+t.x,y:s.y+t.y}),P=(s,t)=>({x:s.x-t.x,y:s.y-t.y}),B=(s,t)=>({x:s.x*t,y:s.y*t}),O=({x:s,y:t})=>({x:t,y:-s}),Y=({x:s,y:t})=>({x:-s,y:-t}),D=({x:s,y:t},e,n)=>{const r=Math.sin(n),i=Math.cos(n),h=s-e.x,o=t-e.y,l=h*i-o*r,u=h*r+o*i;return{x:l+e.x,y:u+e.y}},J=(s,t)=>s.x*t.x+s.y*t.y,tt=(s,t,e)=>I(s,B(P(t,s),e)),L=(s,t,e)=>I(s,B(t,e));class w{constructor(t,e,n,r,i){this.p=t,this.r=e,this.v=n,this.d=r,this.l=i}toJSON(){return[this.p.x,this.p.y,this.r]}dup(t=this.r){return new w(this.p,t,this.v,this.d,this.l)}}class ${constructor(t,e=t.length>0?t[t.length-1].l:0){this.points=t,this.length=e,this.sections=[0],this.pending={__proto__:null},this.queue=[],this.updateSections()}get empty(){return this.points.length==0}get dot(){return this.points.length==1}insert(t,e){if(t==this.points.length)e.forEach(n=>this.push(n,!0)),t=this.points.length,(e=this.pending[t])?(delete this.pending[t],this.insert(t,e)):this.updateSections();else if(t>this.points.length)this.pending[t]&&console.warn(`Override pending points from ${t}`),this.pending[t]=e;else throw new RangeError(`Position ${t} conflicts with existing points`)}push(t,e=!1){let{points:n}=this;if(n.length>0){let r,i=n[n.length-1];r={x:(t.x+i.p.x)/2,y:(t.y+i.p.y)/2,r:t.r};let h=i.p,o=Math.hypot(r.x-h.x,r.y-h.y);if(this.updateLength(o),this.length-i.l<4){i.r=Math.max(i.r,r.r);return}n.push(new w(r,r.r,q(P(h,r)),o,this.length)),e||this.updateSections()}else n.push(new w(t,t.r,{x:1,y:1},0,0))}outline(t,e){let n=this.sections.find(i=>t<i),r=this.points.slice(t>0?t-1:t,n);if(r.length>1){let i=[],h=[],o=r.length,l=e,u=r[0].r,a=!0;n==null&&r[o-1].r==.5&&r[o-1].d>.314*e&&(o-1>=0&&(r[o-1]=r[o-1].dup(Math.max(.1,r[o-1].r-.4))),o-2>=0&&(r[o-2]=r[o-2].dup(Math.max(.1,r[o-2].r-.2))),a=!1);for(let p=0;p<o;p++){let{p:g,r:S,v:_,d:x}=r[p];p==0&&(x=0,p<o-1&&(_=r[p+1].v));let X=Math.min(1,x/e),W=Math.min(1,1-X),j=Math.min(1,u+(W-u)*(X*.3)),z=(p<o-1?r[p+1]:r[p]).v,H=p<o-1?J(_,z):1;l=Math.max(e*(.5*j),.75);let F=B(O(tt(z,_,H)),l),U=P(g,F);i.push(U);let Z=I(g,F);h.push(Z),u=S}let M=[],N=[];for(let p=1/13,g=p;g<=1;g+=p)M.push(D(h[0],r[0].p,3.1416926535897933*g));if(a){let p=r[o-1],g=O(Y(p.v)),S=L(p.p,g,l);for(let _=1/13,x=_;x<1;x+=_)N.push(D(S,p.p,3.1416926535897933*x))}return i.concat(N,h.reverse(),M)}else if(r.length==1){let i=r[0],h=O(Y(i.v)),o=L(i.p,h,e*.36*i.r),l=[];for(let u=1/13,a=0;a<=2;a+=u)l.push(D(o,i.p,3.1416926535897933*a));return l}else return[]}updateLength(t){this.length+=t}updateSections(){let{sections:t}=this;for(let e=t.length>1?t[t.length-1]+1:2,n=this.points.length;e<n;e++)this.points[e].d<1e3&&J(this.points[e].v,this.points[e-1].v)<0&&(t.push(e),e+=1)}updateCurr(t,e){for(this.queue.push(t);this.queue.length>e;)this.queue.shift();let n=0,r=0;for(let i of this.queue)n+=i.x,r+=i.y;return e=this.queue.length,{x:n/e,y:r/e,r:t.r}}toJSON(){return this.points.map(t=>t.toJSON())}static fromJSON(t){if(!t||!Array.isArray(t))throw new RangeError("Invalid JSON representation for Stroke");return $.create(t.map(e=>({x:e[0],y:e[1],r:e[2]})))}static create(t=[]){let e=[],n=0;if(t.length>0){let r=t[0],i=0;e.push(new w(r,r.r,{x:1,y:1},0,0));for(let h=1;h<t.length;h++){let o=t[h],l=Math.hypot(o.x-r.x,o.y-r.y);if(i+=l,i-n<4){e[e.length-1].r=o.r;continue}e.push(new w(o,o.r,q(P(r,o)),l,i)),r=o,n=i}n=i}return new $(e,n)}}class et{constructor(){this._observers=new Map}on(t,e){let n=this._observers.get(t);return n===void 0&&this._observers.set(t,n=new Set),n.add(e),this.off.bind(this,t,e)}off(t,e){let n=this._observers.get(t);n!==void 0&&(n.delete(e),n.size==0&&this._observers.delete(t))}emit(t,...e){let n=this._observers.get(t);n&&n.forEach(r=>this._invoke(r,e))}_invoke(t,e){try{t(...e)}catch(n){console.error(n)}}dispose(){this._observers.clear()}}class it{constructor(t){this.input=t,this.points=new Map,this.x0=0,this.y0=0,this.x1=0,this.y1=0,this.scale=1,this.ox=0,this.oy=0,this.rate=1}_desc(){let t=0,e=0,n=0;for(let r of this.points.values())t+=r.clientX,e+=r.clientY;t/=this.points.size,e/=this.points.size;for(let r of this.points.values())n+=Math.hypot(r.clientX-t,r.clientY-e);return n==0&&(n=1),{x:t,y:e,area:n}}_init(t){this.ox=this.oy=0,this.rate=1/t.area,this.x1=this.x0=t.x,this.y1=this.y0=t.y,this.scale=1}_sync(t){this.ox=this.x1-t.x,this.oy=this.y1-t.y,this.rate=this.scale/t.area}_update(t){this.x1=t.x+this.ox,this.y1=t.y+this.oy,this.scale=t.area*this.rate}get empty(){return this.points.size==0}has(t){return this.points.has(t)}add(t){this.points.set(t.pointerId,t);let e=this._desc();this.points.size==1?this._init(e):(this._sync(e),this._update(e))}move(t){this.points.set(t.pointerId,t),this._update(this._desc()),this.input.emit("pinch",{x:this.x0-this.x1,y:this.y0-this.y1,scale:this.scale})}delete(t){if(this.points.delete(t),this.points.size>0){let e=this._desc();this._sync(e),this._update(e)}}}const R=typeof navigator<"u"?navigator:{platform:""},E={mac:/Mac/.test(R.platform),windows:/Win/.test(R.platform)};class C extends et{constructor(t=!1,e=!0,n=!0,r=!0){super(),this.paused=t,this.gesture=e,this.pressure=n,this.windowsScroll=r,this._map=new Map,this._pinch=new it(this),this._onpointerdown=i=>{if(this.paused)return;let h=i.pointerId;if(this._map.has(h)&&this.emit("cancel",h),this._map.set(h,i),i.preventDefault(),i.stopPropagation(),this._dom.setPointerCapture(h),this._mapGesture(i)&&this._map.size>1)this._map.forEach((o,l)=>{this._pinch.has(l)||(h!=l&&this.emit("cancel",l),this._pinch.add(o))});else{let o=this._rect=this._dom.getBoundingClientRect();this.emit("open",h,{x:i.clientX-o.left,y:i.clientY-o.top,r:this._mapPressure(i.pressure)})}},this._onpointermove=i=>{if(this.paused)return;let h=i.pointerId;if(i.preventDefault(),i.stopPropagation(),this._map.has(h)){let o=this._map.get(h);if(o.clientX==i.clientX&&o.clientY==i.clientY)return;if(this._map.set(h,i),this._pinch.empty){let l;i.pointerType=="mouse"&&i.pressure==0&&(l=this._mapPressure(.5));let{left:u,top:a}=this._rect;if(i.getCoalescedEvents)for(let M of i.getCoalescedEvents())this.emit("update",h,{x:M.clientX-u,y:M.clientY-a,r:l??this._mapPressure(i.pressure)});else this.emit("update",h,{x:i.clientX-u,y:i.clientY-a,r:l??this._mapPressure(i.pressure)})}else this._pinch.move(i)}},this._onpointerup=i=>{var o;if(this.paused)return;let h=i.pointerId;if(i.preventDefault(),i.stopPropagation(),this._map.has(h)){if(this._pinch.empty){if(i.getPredictedEvents){let l=(o=this._map.get(h))==null?void 0:o.getPredictedEvents()[0],u=this._rect;l&&this.emit("update",h,{x:Math.round(l.clientX-u.left),y:Math.round(l.clientY-u.top),r:this._mapPressure(l.pressure)})}this.emit("close",h)}else this._pinch.delete(h);this._map.delete(h)}},this._onpointercancel=i=>{if(this.paused)return;let h=i.pointerId;i.preventDefault(),i.stopPropagation(),this._map.delete(h),this._pinch.empty?this.emit("cancel",h):this._pinch.delete(i.pointerId)},this._onwheel=i=>{i.preventDefault(),i.stopPropagation();let{deltaX:h,deltaY:o}=i,l=Math.hypot(h,o),u=0,a=0;E.windows&&(l=-l),h+o<0&&(l=-l),E.mac&&i.ctrlKey?l=-l*.5:E.mac&&(i.wheelDelta%120!=0||i.movementX!=0||i.deltaX!=0)||this.windowsScroll&&E.windows&&!i.ctrlKey?(u=-h,a=-o,l=0):l*=.035,l=1+Math.max(l,-40)*.02,this.emit("pinch",{x:u,y:a,scale:l})}}get dom(){return this._dom}set dom(t){this._dom!=t&&(this._dom=t,this._listen(this._dom,{pointerdown:this._onpointerdown,pointermove:this._onpointermove,pointerup:this._onpointerup,pointerout:this._onpointerup,pointercancel:this._onpointercancel,wheel:this._onwheel}),this._dom&&(this._rect=this._dom.getBoundingClientRect()))}pause(){this.paused=!0}resume(){this.paused=!1}_listen(t,e){if(this._unlistenDOM&&(this._unlistenDOM(),this._unlistenDOM=void 0),t){for(let n in e)t.addEventListener(n,e[n]);this._unlistenDOM=()=>{for(let n in e)t.removeEventListener(n,e[n])}}}_clamp(t,e,n){return t<=e?e:t>n?n:t}_mapPressure(t){return this.pressure===!0?t:this._clamp(this.pressure||.5,0,1)}_mapGesture(t){return this.gesture===!0||this.gesture&&t.pointerType=="touch"}dispose(){this._unlistenDOM&&(this._unlistenDOM(),this._unlistenDOM=void 0),super.dispose()}static create(t={}){let e=new C(t.paused,t.gesture,t.pressure,t.windowsScroll);return e.dom=t.dom,e}}let st=document.getElementById("app"),f=document.createElementNS("http://www.w3.org/2000/svg","svg"),d=document.createElementNS("http://www.w3.org/2000/svg","g"),m={size:document.getElementById("stroke-size"),clear:document.getElementById("clear"),undo:document.getElementById("undo"),redo:document.getElementById("redo"),outline:document.getElementById("outline"),data:document.getElementById("data")},V=0,T=0;function nt(s){try{let t=JSON.stringify(s.toJSON()).length;T+=t,m.data.textContent=`${V.toFixed(1)}ms, ${G(t)} (Total: ${G(T)})`}catch(t){console.error(t)}}function G(s){return s<1024?s+" B":(s/1024).toFixed(1)+" kB"}let k={index:0,stack:[],get undoable(){return this.index>0},get redoable(){return this.index<this.stack.length},commit(s,t){for(this.stack[this.index]={undo:s,redo:t},this.index+=1;this.stack.length>20;)this.stack.shift(),this.index-=1;this.stack.length=this.index,this.update()},undo(){this.undoable&&(this.index-=1,this.stack[this.index].undo(),this.update())},redo(){this.redoable&&(this.stack[this.index].redo(),this.index+=1,this.update())},update(){m.undo.disabled=!this.undoable,m.redo.disabled=!this.redoable}};f.append(d);st.append(f);m.clear.onclick=()=>{let s=Array.from(d.children);d.textContent="",k.commit(()=>d.append(...s),()=>d.textContent="")};m.undo.onclick=()=>k.undo();m.redo.onclick=()=>k.redo();d.setAttribute("fill","currentColor");m.outline.oninput=()=>{m.outline.checked?(d.setAttribute("fill","none"),d.setAttribute("stroke","currentColor"),d.setAttribute("stroke-width","1")):d.setAttribute("fill","currentColor")};f.setAttribute("fill-rule","nonzero");f.style.cssText="display: block; width: 100%; height: 100%; font-size: 0; touch-action: none; position: relative; contain: content";let y=!1,c={__proto__:null},b={__proto__:null},v=C.create({dom:f});v.on("open",(s,t)=>{let e=$.create([t]),n=document.createElementNS("http://www.w3.org/2000/svg","path");n.style.pointerEvents="none",c[s]=[e,n],b[s]=!0,d.append(n),!y&&(y=!0,queueMicrotask(A))});v.on("update",(s,t)=>{if(c[s]){let[e]=c[s];if(e.push(t),b[s]=!0,y)return;y=!0,queueMicrotask(A)}});v.on("cancel",s=>{c[s]&&(c[s][1].remove(),delete c[s])});v.on("close",s=>{if(c[s]){let[t,e]=c[s],n=!0;t.empty&&(e.remove(),n=!1),nt(t),console.log(t),y=!0,A(),delete c[s],n&&k.commit(()=>e.remove(),()=>d.append(e))}});f.ontouchstart=f.ontouchmove=f.ontouchend=f.ontouchcancel=s=>{s.preventDefault(),s.stopPropagation()};const K=(s,t)=>({x:(s.x+t.x)/2,y:(s.y+t.y)/2}),rt=({x:s,y:t})=>`M${s.toFixed(2)},${t.toFixed(2)}`,Q=({x:s,y:t})=>`L${s.toFixed(2)},${t.toFixed(2)}`,ot=(s,{x:t,y:e})=>`Q${s.x.toFixed(2)},${s.y.toFixed(2)} ${t.toFixed(2)},${e.toFixed(2)}`;function A(){if(!y)return;y=!1;let s=m.size.valueAsNumber,t=performance.now();for(let e in b){if(c[e]){let[n,r]=c[e],i="";for(let h of n.sections)i+=ht(n.outline(h,s));r.setAttribute("d",i)}delete b[e]}V=performance.now()-t}function ht(s){if(s.length==0)return"";let t=s.shift(),e=rt(t),n=1;for(let r of s)n&&(e+=Q(K(t,r))),e+=ot(t,K(t,r)),n=0,t=r;return e+Q(s[s.length-1])}Object.assign(window,{debug:{undoStack:k,strokes:c,dirty:b,input:v}});
//# sourceMappingURL=index-DWrVlt6I.js.map

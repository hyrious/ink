const Q=(t,e,i)=>t<e?e:t>i?i:t;class u{constructor(e,i){this.x=e,this.y=i}static of(e,i){return new u(e,i)}static from(e){return new u(e.x,e.y)}add(e){return new u(this.x+e.x,this.y+e.y)}subtract(e){return new u(this.x-e.x,this.y-e.y)}multiply(e){return new u(this.x*e,this.y*e)}normalize(e=Math.hypot(this.x,this.y)){return new u(this.x/e,this.y/e)}permutate(){return new u(-this.y,this.x)}negative(){return new u(-this.x,-this.y)}middle(e){return new u((this.x+e.x)/2,(this.y+e.y)/2)}rotate(e,i){const s=Math.sin(i),r=Math.cos(i),o=this.x-e.x,l=this.y-e.y,a=o*r-l*s,h=o*s+l*r;return new u(a+e.x,h+e.y)}dot(e){return this.x*e.x+this.y*e.y}lerp(e,i){return new u(this.x+(e.x-this.x)*i,this.y+(e.y-this.y)*i)}project(e,i){return new u(this.x+e.x*i,this.y+e.y*i)}}class le{constructor(e=.36){this.value=this.last=this.target=e}set(e){return this.target=e,this}update(e){if(e||(e=.016667),this.value>=0&&this.target>=0&&this.last>=0){let s=this.target-this.value,r=(this.value-this.last)/e,o=2*s,l=.1*r,a=o-l,h=(r+a)*e;this.last=this.value,Math.abs(h)<.01&&Math.abs(s)<.01?this.value=this.target:this.value+=h}return this.value}}class y{constructor(e,i,s,r){this.x=e,this.y=i,this.p=s,this.t=r}static of(e,i,s,r){return new y(e,i,s,r)}static fromEvent(e,i=Q(e.pressure||.5,0,1)){return new y(e.clientX,e.clientY,i,performance.timeOrigin+e.timeStamp)}static fromJSON(e){return new y(e.x,e.y,e.p,e.t)}}class P{constructor(e,i,s,r){this.p=e,this.v=i,this.d=s,this.l=r}static of(e,i,s,r){return new P(e,i,s,r)}static fromJSON(e){return new P(y.fromJSON(e.p),u.from(e.v),e.d,e.l)}}function ae(t,e){return e-t.p.t>60?Math.min(t.p.p+.05,1):Math.min(t.p.p+.05*(e-t.p.t)/60,1)}function he(t,e,i){return i-e>60?Math.min(t+.05,1):Math.min(t+.05*(i-e)/60,1)}class z{constructor(e,i=e.length>0?e[e.length-1].l:0){this.points=e,this.length=i,this.segments=[0],this.pending={__proto__:null}}static of(e=[]){let i=new z([],0);for(let s of e)i._push(s);return i._updateSegments(),i}static fromJSON(e){let i=new z(e.points.map(P.fromJSON),e.length);return i.segments=e.segments,i.pending=e.pending,i}get empty(){return this.length==0}get dot(){return this.points.length==1}insert(e,i){if(e==this.points.length){for(let s of i)this._push(s);e=this.points.length,(i=this.pending[e])?(delete this.pending[e],this.insert(e,i)):this._updateSegments()}else if(e>this.points.length)this.pending[e]=i;else throw new RangeError(`Position ${e} conflicts with existing points`);return this}push(e){return this._push(e),this._updateSegments(),this}_push(e){let i=this.points;if(i.length>0){let s=i[i.length-1],r=Math.hypot(e.x-s.p.x,e.y-s.p.y);if(this._updateLength(r),this.length-s.l<4){s.p.p=Math.max(s.p.p,e.p);return}i.push(P.of(e,u.from(e).subtract(s.p).normalize(),r,this.length))}else i.push(P.of(e,u.of(0,0),0,0))}isSpreading(e=performance.timeOrigin+performance.now()){return this.points.length>0&&e-this.points[this.points.length-1].p.t<60}outline(e,i,s=performance.timeOrigin+performance.now(),r=!0){let o=this.segments.find(a=>e<a),l=this.points.slice(e>0?e-1:e,o);if(l.length>1){let a=[],h=[],c=l.length,O=i,w=l[0].p.p,ee=l[c-1].p.p,T=!0,N=-1,K=l[0].p.t,te=new le(Math.max(w,.36/5));if(r&&o==null&&c>=2&&(w==.5||w==1||ee<.72)){T=!1;let d=l[c-2],m=d.d,S=d,b=0;for(let v=c-3;v>=0&&(S=l[v],m+=S.d,b=d.p.t-S.p.t,!(b<=0||b>100));v--)N=v;m>.51*i?N+=Math.ceil((c-N)/3):N=c-3}for(let d=0;d<c;d++){let{p:m,v:S,d:b}=l[d];d==0&&(b=0,S=l[1].v);let v=Math.min(1,b/i),se=Math.min(1,1-v),A=Math.min(1,w+(se-w)*(v*.5)),Y=(d<c-1?l[d+1]:l[d]).v,ne=d<c-1?S.dot(Y):1;if(A=te.set(A).update((m.t-K)/800),!T&&d>=N){let G=1-(c-d-1)/(c-N);A=A*(1-G*G)}O=Q(i*.5*he(A,m.t,s),.75,i/2);let j=Y.lerp(S,ne).permutate().multiply(O),re=u.from(m).subtract(j),oe=u.from(m).add(j);a.push(re),h.push(oe),K=m.t,w=m.p}let U=[],ie=h[0],X=[];for(let d=1/13,m=0;m<=1;m+=d)U.push(ie.rotate(l[0].p,3.1416926535897933*m));if(T){let d=l[c-1],m=d.v.negative().permutate(),S=u.from(d.p).project(m,O);for(let b=1/13,v=0;v<1;v+=b)X.push(S.rotate(d.p,3.1416926535897933*v))}return a.concat(X,h.reverse(),U)}else if(l.length==1){let a=l[0],h=u.from(a.p).project(u.of(1,0),i*.36*ae(a,s)),c=[];for(let O=1/13,w=0;w<=2;w+=O)c.push(h.rotate(a.p,3.1416926535897933*w));return c}else return[]}stroke(e=this.points.map(s=>s.p),i=!1){let s=e.length;if(s==0)return"";let r=e[0],o="",l,a;if(i){a=u.from(r).middle(e[s-1]),o+=`M${a.x.toFixed(2)},${a.y.toFixed(2)}`;for(let h=1;h<s;h++)l=e[h],a=u.from(r).middle(l),o+=`Q${r.x.toFixed(2)},${r.y.toFixed(2)} ${a.x.toFixed(2)},${a.y.toFixed(2)}`,r=l;s>1&&(o+="Z")}else{o+=`M${r.x.toFixed(2)},${r.y.toFixed(2)}`;for(let h=1;h<s;h++)l=e[h],a=u.from(r).middle(l),h==1?o+=`L${a.x.toFixed(2)},${a.y.toFixed(2)}`:o+=`Q${r.x.toFixed(2)},${r.y.toFixed(2)} ${a.x.toFixed(2)},${a.y.toFixed(2)}`,r=l;s>1&&(o+=`L${r.x.toFixed(2)},${r.y.toFixed(2)}`)}return o}_updateLength(e){this.length+=e}_updateSegments(){let e=this.segments,i=this.points,s=i.length;for(let r=e[e.length-1]+1;r<s;r++)i[r].v.dot(i[r-1].v)<0&&(e.push(r),r++)}}let Z=document.getElementById("app"),p=Z.appendChild(document.createElementNS("http://www.w3.org/2000/svg","svg")),g=Z.appendChild(document.createElement("div")),n={color:document.getElementById("stroke-color"),size:document.getElementById("stroke-size"),clear:document.getElementById("clear"),undo:document.getElementById("undo"),redo:document.getElementById("redo"),save:document.getElementById("save"),load:document.getElementById("load"),pressure:document.getElementById("pressure"),tail:document.getElementById("tail"),eraser:document.getElementById("eraser"),smooth:document.getElementById("smooth")},pe=n.pressure.checked,ue=n.tail.checked,de=n.smooth.value,ce=n.size.valueAsNumber;p.setAttribute("fill-rule","nonzero");p.setAttribute("fill","currentColor");p.style.cssText=`display: block; width: 100%; height: 100%;
font-size: 0; touch-action: none; position: relative; contain: content;
overflow: hidden; overscroll-behavior: none;`;g.style.cssText=`display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
touch-action: none; contain: content; z-index: 1;`;let fe=matchMedia("(prefers-color-scheme: dark)"),H=()=>fe.matches?"#ffffff":"#000000";n.color.value=H();n.color.onchange=n.color.oninput=()=>{C()};n.size.onchange=n.size.oninput=()=>{C()};n.clear.onclick=()=>{let t=Array.from(p.children);p.textContent="",J.commit(()=>p.append(...t),()=>p.textContent="")};n.undo.onclick=()=>J.undo();n.redo.onclick=()=>J.redo();let $=t=>Math.round((t+Number.EPSILON)*100)/100;n.save.onclick=async()=>{let t=[];for(const o of p.children){let l=Number.parseInt(o.dataset.index??"");t.push(F[l])}t=structuredClone(t),sessionStorage.setItem("ink",JSON.stringify(t));let e=0,i=0;for(let o of t){o.length=$(o.length);for(let l of o.points)l.d=$(l.d),l.l=$(l.l),l.v.x=$(l.v.x),l.v.y=$(l.v.y),l.p.x=$(l.p.x),l.p.y=$(l.p.y),l.p.p=$(l.p.p),i=l.p.t,l.p.t=$(i-e),e=i}let s=JSON.stringify(t);n.save.disabled=!0;let r=await showSaveFilePicker({id:"ink",startIn:"downloads",suggestedName:"ink.json"}).catch(console.warn);if(r){let o=await r.createWritable().catch(console.warn);o&&(await o.write(s),await o.close())}n.save.disabled=!1};n.load.onclick=async()=>{let[t]=await showOpenFilePicker({id:"ink",startIn:"downloads"}).catch(e=>(console.warn(e),[]));if(t){let e=await t.getFile().catch(console.warn);if(e){let i;try{i=JSON.parse(await e.text())}catch(s){console.warn(s)}if(i&&Array.isArray(i)){n.clear.click();let s=101,r=0;for(let o of i){for(let h of o.points)h.p.t+=r,r=h.p.t;let l=z.fromJSON(o),a=p.appendChild(document.createElementNS("http://www.w3.org/2000/svg","path"));a.style.pointerEvents="none",a.style.fill=n.color.value,a.dataset.index=String(F.push(l)-1),f[s]=[l,a],E[s]=!0,s++}M();for(let o=101;o<s;o++)delete f[o]}}}};setTimeout(()=>{let t=JSON.parse(sessionStorage.getItem("ink")??"[]");if(t&&Array.isArray(t)){n.clear.click();let e=101;for(let i of t){let s=z.fromJSON(i),r=p.appendChild(document.createElementNS("http://www.w3.org/2000/svg","path"));r.style.pointerEvents="none",r.style.fill=n.color.value,r.dataset.index=String(F.push(s)-1),f[e]=[s,r],E[e]=!0,e++}M();for(let i=101;i<e;i++)delete f[i]}});let B;n.pressure.oninput=()=>{B=n.pressure.checked?void 0:.5,C()};n.tail.oninput=()=>{C()};n.smooth.onchange=n.smooth.oninput=()=>{C()};n.eraser.oninput=()=>{let t=n.eraser.checked;g.style.cursor=t?`url(https://api.iconify.design/mdi:eraser.svg?color=${encodeURIComponent(n.color.value)}) 12 32, auto`:"default",g.style.display=t?"block":"none"};for(let t=1;t<=15;t++){let e=document.createElement("option");e.value=e.textContent=String(t),n.smooth.appendChild(e)}let C=()=>{let t="";n.color.value!==H()&&(t+=`&color=${n.color.value.slice(1)}`),n.size.valueAsNumber!==ce&&(t+=`&size=${n.size.valueAsNumber}`),n.pressure.checked!==pe&&(t+=`&pressure=${n.pressure.checked?1:0}`),n.tail.checked!==ue&&(t+=`&tail=${n.tail.checked?1:0}`),n.smooth.value!==de&&(t+=`&smooth=${n.smooth.value}`),history.replaceState({},"",t?t.replace("&","?"):location.pathname)},k=new URL(location.href).searchParams;k.has("color")&&(n.color.value="#"+k.get("color"));k.has("size")&&(n.size.value=k.get("size"));k.has("pressure")&&(n.pressure.checked=k.get("pressure")!=="0",n.pressure.dispatchEvent(new InputEvent("input")));k.has("tail")&&(n.tail.checked=k.get("tail")!=="0",n.tail.dispatchEvent(new InputEvent("input")));k.has("smooth")&&(n.smooth.value=k.get("smooth"));C();let x=new Map;p.onpointerdown=t=>{let e=t.pointerId;x.has(e)&&_(e),x.set(e,t),t.preventDefault(),t.stopPropagation(),p.setPointerCapture(e),xe(e,y.fromEvent(t,B))};p.onpointermove=t=>{let e=t.pointerId;if(t.preventDefault(),t.stopPropagation(),x.has(e)){let i=x.get(e);if(i.clientX===t.clientX&&i.clientY===t.clientY)return;if(x.set(e,t),t.getCoalescedEvents)for(let s of t.getCoalescedEvents())L(e,y.fromEvent(s,B));else L(e,y.fromEvent(t,B))}};p.onpointerup=p.onpointerout=t=>{let e=t.pointerId;if(t.preventDefault(),t.stopPropagation(),x.has(e)){if(t.getPredictedEvents){let i=x.get(e).getPredictedEvents()[0];i&&L(e,y.fromEvent(i,B))}we(e),x.delete(e)}};p.onpointercancel=t=>{let e=t.pointerId;t.preventDefault(),t.stopPropagation(),x.has(e)&&(_(e),x.delete(e))};p.ontouchstart=p.ontouchmove=p.ontouchend=p.ontouchcancel=t=>{t.preventDefault(),t.stopPropagation()};let I;g.onpointerdown=t=>{t.preventDefault(),t.stopPropagation(),g.setPointerCapture(t.pointerId),V(I=y.fromEvent(t))};g.onpointermove=t=>{if(I){t.preventDefault(),t.stopPropagation();let e=y.fromEvent(t);V(e),I=e}};g.onpointerup=g.onpointerout=t=>{I=void 0};g.ontouchstart=g.ontouchmove=g.ontouchend=g.ontouchcancel=t=>{t.preventDefault(),t.stopPropagation()};let J={index:0,stack:[],get undoable(){return this.index>0},get redoable(){return this.index<this.stack.length},commit(t,e){for(this.stack[this.index]={undo:t,redo:e},this.index++;this.stack.length>20;)this.stack.shift(),this.index--;this.stack.length=this.index,this.update()},undo(){this.undoable&&(this.index--,this.stack[this.index].undo(),this.update())},redo(){this.redoable&&(this.stack[this.index].redo(),this.index++,this.update())},update(){n.undo.disabled=!this.undoable,n.redo.disabled=!this.redoable}};class me{push(e){return this.item=e,this}dup(){if(this.item)return this}get(){return this.item}}class ge{constructor(e,i=2){this.compute=e,this.capacity=i,this.items=[],this.size=0}push(e){for(this.items.push(e),this.size++;this.size>this.capacity;)this.items.shift(),this.size--;return this}dup(){if(this.size>0)return this.push(this.items[this.items.length-1])}get(){return this.compute(this.items)}}let ye=t=>{let e=0,i=0,s=.5,r=0;for(let o of t)e+=o.x,i+=o.y,s=o.p,r=o.t;return y.of(e/t.length,i/t.length,s,r)},ve=t=>{if(n.smooth.value=="0")return new me().push(t);{let e=Number.parseInt(n.smooth.value)+1;return new ge(ye,e).push(t)}},f={},D={},E={},F=[],xe=(t,e)=>{let i=z.of([e]),s=p.appendChild(document.createElementNS("http://www.w3.org/2000/svg","path"));s.style.pointerEvents="none",s.style.fill=n.color.value,f[t]=[i,s],D[t]=ve(e),E[t]=!0,M()},L=(t,e)=>{f[t]&&(f[t][0].push(D[t].push(e).get()),E[t]=!0,M(),q())},_=t=>{f[t]&&(f[t][1].remove(),delete D[t],delete f[t],delete E[t])},we=t=>{if(f[t]){let[e,i]=f[t],s=!0;e.empty&&!e.dot&&(i.remove(),s=!1),M(),delete D[t],delete E[t],q(),s&&J.commit(()=>i.remove(),()=>p.append(i)),s&&(i.dataset.index=String(F.push(e)-1))}},V=t=>{let e=p.createSVGPoint();e.x=t.x,e.y=t.y;for(let i of p.children)i.isPointInFill(e)&&i.remove();if(I){let i=t.x-I.x,s=t.y-I.y;for(let r=0;r<1;r+=.1){let o=p.createSVGPoint();o.x=t.x-r*i,o.y=t.y-r*s;for(let l of p.children)l.isPointInFill(o)&&l.remove()}}},M=()=>{let t=performance.timeOrigin+performance.now(),e=n.size.valueAsNumber,i=n.tail.checked;for(let s in E){if(f[s]){let r=x.has(+s),[o,l]=f[s],a="";for(let h of o.segments){let c=o.outline(h,e,t,!r&&i);a+=o.stroke(c,!0)}l.setAttribute("d",a)}delete E[s]}clearTimeout(R),R=setTimeout(()=>{let s=[];for(const r of p.children){let o=Number.parseInt(r.dataset.index??"");s.push(F[o])}sessionStorage.setItem("ink",JSON.stringify(s))},1e3)},R=0,W=0,q=()=>{cancelAnimationFrame(W),W=requestAnimationFrame(ke)},ke=()=>{var e;M();let t=!1;for(let i in f){let s=(e=D[i])==null?void 0:e.dup();s&&f[i][0].push(s.get()),f[i][0].isSpreading()&&(E[i]=!0,t=!0)}t&&q()},Ee=/Mac/.test(navigator.platform);document.onkeydown=t=>{let e=t.ctrlKey,i=t.shiftKey,s=t.metaKey,r=t.altKey,o=t.keyCode,l=Ee?s:e;const a=h=>{t.preventDefault(),h.focus(),h.click()};if(!e&&!i&&!s&&!r){if(o==80&&(n.eraser.checked?a(n.eraser):a(n.pressure)),o==69&&a(n.eraser),o==219||o==221){let h=n.size.valueAsNumber,c=o==221?5:-5;n.size.value=""+Q(h+c,+n.size.min,+n.size.max),n.size.dispatchEvent(new InputEvent("input"))}o===84&&a(n.tail)}else l&&!i&&o==90?a(n.undo):l&&i&&o==90?a(n.redo):l&&!i&&o==83?a(n.save):l&&!i&&o==79&&a(n.load)};Object.assign(globalThis,{$settings:n,$svg:p,strokes:f,dirty:E,undoStack:J,allStrokes:F});
//# sourceMappingURL=main-BpACEZc9.js.map
